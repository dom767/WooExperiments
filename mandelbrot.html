<HTML>
<HEAD>
<SCRIPT>

var stop=false;
var gZoom=0.5;
var gPosX=0;
var gPosY=0;
var mandelArray=new Array();
var gWidth = 1280;
var gHeight = 700;

// progressive renderer
var gComplete = false;
var gProgressiveIndex = 0;
var gProgressiveLevel = 16;
var gSmoothShading = false;

//////////////////////////COLOUR///////////////////////////////
function colour(r, g, b)
{
 this.mR = r;
 this.mG = g;
 this.mB = b;
}

colour.prototype.mul = function()
{
 var mul = arguments[0];
 return new colour(this.mR*mul, this.mG*mul, this.mB*mul);
}

// Original... https://stackoverflow.com/questions/2353211/hsl-to-rgb-color-conversion
colour.prototype.SetHSL = function()
{
 var h = arguments[0];
 var s = arguments[1];
 var l = arguments[2];

    if(s == 0){
        this.mR = this.mG = this.mB = l; // achromatic
    }else{
        var hue2rgb = function hue2rgb(p, q, t){
            if(t < 0) t += 1;
            if(t > 1) t -= 1;
            if(t < 1/6) return p + (q - p) * 6 * t;
            if(t < 1/2) return q;
            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        }

        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        var p = 2 * l - q;
        this.mR = hue2rgb(p, q, h + 1/3);
        this.mG = hue2rgb(p, q, h);
        this.mB = hue2rgb(p, q, h - 1/3);
    }
}

function ColourKeyframe(pos, col)
{
 this.mColour = col;
 this.mPosition = pos;
}

//////////////////////////COLOURGRADIENT///////////////////////////////
function ColourGradient()
{
 this.mColourKeyframe = new Array();
 this.mColourKeyframe[0] = new ColourKeyframe(0.0, new colour(0,0,0));
 this.mColourKeyframe[1] = new ColourKeyframe(1.0, new colour(1,1,1));
}

ColourGradient.prototype.AddKeyframe = function()
{
 var position = arguments[0];
 var colour = arguments[1];

 for (i=0; i<this.mColourKeyframe.length; i++)
 {
   var start = this.mColourKeyframe[i].mPosition;
   var end = 1;
   if (i<this.mColourKeyframe.length-1)
   {
    end = this.mColourKeyframe[i+1].mPosition;
   }
  if (position>start && position<=end)
  {
   var numShuffle = this.mColourKeyframe.length - (i+1);
   this.mColourKeyframe[this.mColourKeyframe.length] = this.mColourKeyframe[this.mColourKeyframe.length-1];
   for (j=0; j<numShuffle; j++)
   {
    this.mColourKeyframe[(this.mColourKeyframe.length-1)-j] = this.mColourKeyframe[((this.mColourKeyframe.length-1)-j)-1] 
   }
   this.mColourKeyframe[i+1] = new ColourKeyframe(position, colour);
  }
 }
}

ColourGradient.prototype.GetColour = function()
{
 var position = arguments[0];
 for (i=0; i<this.mColourKeyframe.length; i++)
 {
   var start = this.mColourKeyframe[i].mPosition;
   var end = 1;
   if (i<this.mColourKeyframe.length-1)
   {
    end = this.mColourKeyframe[i+1].mPosition;
   }
  if (position>start && position<=end)
  {
   var delta = (position-start) / (end-start);
   var r = this.mColourKeyframe[i+1].mColour.mR * delta + this.mColourKeyframe[i].mColour.mR * (1-delta);
   var g = this.mColourKeyframe[i+1].mColour.mG * delta + this.mColourKeyframe[i].mColour.mG * (1-delta);
   var b = this.mColourKeyframe[i+1].mColour.mB * delta + this.mColourKeyframe[i].mColour.mB * (1-delta);
   return new colour(r, g, b);
  }
 }
}

var gColourGradient = new ColourGradient();

function clamp(value, min, max)
{
 if (value<=min) return min;
 if (value>=max) return max;
 return value;
}

function Initialise()
{
 for (y=0; y<gHeight; y++)
  for (x=0; x<gWidth; x++)
   {
    mandelArray[(x+gWidth*y)]=Math.random()*255.99;
   }
 gColourGradient.AddKeyframe(0.6, new colour(1,0.5,0));
 gColourGradient.AddKeyframe(0.4, new colour(1,1,1));
 gColourGradient.AddKeyframe(0.2, new colour(0,0.5,1));
 gColourGradient.AddKeyframe(0.8, new colour(0,0,0));
 RenderAgain();
 guiSetInitialParams();
 document.getElementById("canvas1").addEventListener("mousedown", canvasMouseDown);
 document.getElementById("body").addEventListener("mouseup", MouseUp);
 document.addEventListener("mouseleave", MouseLeave);
 document.addEventListener("mousemove", MouseMove);
}

function DrawMandelbrot()
{
 var canvas = document.getElementById('canvas1');
 if (canvas.getContext)
 {
  var ctx = canvas.getContext('2d');
  var imageData = ctx.getImageData(0, 0, gWidth, gHeight);

  ctx.clearRect(0,0,gWidth,gHeight);
  for (y=0; y<gHeight; y++)
   for (x=0; x<gWidth; x++)
   {
    var idx = (x+y*gWidth);
	var m = mandelArray[idx];
    var col = gColourGradient.GetColour(m/256);
	imageData.data[4*(x+y*gWidth)] = col.mR*255.99;
    imageData.data[4*(x+y*gWidth)+1] = col.mG*255.99;
    imageData.data[4*(x+y*gWidth)+2] = col.mB*255.99;
    imageData.data[4*(x+y*gWidth)+3] = 255;
    
   }
   ctx.putImageData(imageData,0,0);
 }
}



function CalculateMandelbrot(progressiveLevel, progressiveIndex)
{
 var rows=0;
 switch(progressiveLevel)
 {
  case 16:
   rows = gHeight;
   break;
  case 8:
   rows = gHeight;
   break;
  case 4:
   rows = gHeight/4;
   break;
  case 2:
   rows = gHeight/16;
   break;
  case 1:
   rows = gHeight/64;
   break;
  case 0.5:	
   rows = gHeight/64;
   break;
  case 0.25:	
   rows = gHeight/64;
   break;
 }
 var rZoom = 1 / gZoom;
 var progressive = progressiveLevel>1 ? progressiveLevel : 1;
 var antialias = progressiveLevel<1 ? 1/progressiveLevel : 1;
 for (y=Math.floor(rows*progressiveIndex*progressive); y<Math.floor(rows*progressive*(progressiveIndex+1)); y+=progressive)
   for (x=0; x<gWidth; x+=progressive)
   {
	var sumIterations = 0;
	for (ay=0; ay<antialias; ay++)
	 for (ax=0; ax<antialias; ax++)
	 {
      var mx = gPosX + rZoom * ((ax*1/antialias)+x-(gWidth/2)) / (gWidth/2)
      var my = gPosY + rZoom * ((ay*1/antialias)+y-(gHeight/2)) / (gWidth/2)
  	  var newx = 0;
  	  var newy = 0;
	  var oldx = 0;
	  var oldy = 0;
	  var mag2 = 0;
	
      for (var i=0; i<256 & mag2 < 4; i++)
  	  {
	   oldx = newx;
	   oldy = newy;
	   newx = oldx * oldx - oldy * oldy + mx;
	   newy = 2 * oldx * oldy + my;
	   mag2 = newx*newx + newy*newy;
	  }
	
	  var iterations = i;

      if (gSmoothShading && mag2>=4)
	   iterations -= (Math.log(Math.log(Math.sqrt(mag2))) / Math.log(2)) - 1;
	   
	  sumIterations += iterations;
	 }
	sumIterations /= (antialias*antialias);
    for (py = 0; py<progressive & y+py<gHeight; py++)
	 for (px=0; px<progressive & x+px<gWidth; px++)
	 {
	  mandelArray[x+px+(gWidth*(y+py))] = clamp(sumIterations, 0, 256);
	 }
   }
}

function guiDraw()
{
 RenderAgain();
}

var gDragStartX, gDragStartY;
var gMouseDown = false;

function canvasMouseDown(e)
{
 gMouseDown = true;
 var worldX = e.pageX;
 var worldY = e.pageY;
 
 var canvasElement = document.getElementById('canvas1');
 var canvasX = worldX - canvasElement.offsetLeft;
 var canvasY = worldY - canvasElement.offsetTop;

 gDragStartX = canvasX;
 gDragStartY = canvasY;
 console.log("Mouse Down : " + canvasX + ", " + canvasY);
}

function MouseUp(e)
{
 gMouseDown = false;
 var worldX = e.pageX;
 var worldY = e.pageY;
 
 var canvasElement = document.getElementById('canvas1');
 var canvasX = worldX - canvasElement.offsetLeft;
 var canvasY = worldY - canvasElement.offsetTop;

 console.log("Mouse Up : " + canvasX + ", " + canvasY);
}

function MouseMove(e)
{
 var worldX = e.pageX;
 var worldY = e.pageY;
 
 var canvasElement = document.getElementById('canvas1');
 var canvasX = worldX - canvasElement.offsetLeft;
 var canvasY = worldY - canvasElement.offsetTop;

 if (gMouseDown && (gDragStartX!=canvasX || gDragStartY!=canvasY))
 {
  console.log("Mouse Move : " + canvasX + ", " + canvasY);
  gPosX -= (canvasX - gDragStartX)/((gWidth*gZoom)/2);
  gPosY -= (canvasY - gDragStartY)/((gWidth*gZoom)/2);
  gDragStartX = canvasX;
  gDragStartY = canvasY;
  RenderAgain();
 }
}

function MouseLeave(e)
{
 console.log("Mouse Leave");
 if (gMouseDown)
  MouseUp(e);
}

function SetZoom(zoom)
{
 gZoom = zoom;
 var guiZoom = document.getElementById('zoom');
 guiZoom.value = zoom;
}

function guiZoomIn()
{
 SetZoom(gZoom * 1.1);
 RenderAgain();
}

function guiZoomOut()
{
 SetZoom(gZoom / 1.1);
 RenderAgain();
}

function guiMoveUp()
{
 gPosY -= 0.1/gZoom;
 RenderAgain();
}

function guiMoveDown()
{
 gPosY += 0.1/gZoom;
 RenderAgain();
}

function guiMoveLeft()
{
 gPosX -= 0.1/gZoom;
 RenderAgain();
}

function guiMoveRight()
{
 gPosX += 0.1/gZoom;
 RenderAgain();
}

function guiSetInitialParams()
{
 var guiInitialAnimals = document.getElementById('initialAnimals');
 guiInitialAnimals.value = initialAnimals;
 var guiZoom = document.getElementById('zoom');
 guiZoom.value = gZoom;
 var guiSmoothShading = document.getElementById('smoothShading');
 guiSmoothShading.checked = gSmoothShading;
}

function guiReadParameters()
{
 var guiInitialAnimals = document.getElementById('initialAnimals');
 initialAnimals = guiInitialAnimals.value;
 var guiZoom = document.getElementById('zoom');
 gZoom = guiZoom.value;
 var guiSmoothShading = document.getElementById('smoothShading');
 gSmoothShading = guiSmoothShading.checked;
 RenderAgain();
}

function RenderAgain()
{
 gDirty = true;
 if (!stop)
  setTimeout(Tick, 17);
}

function DrawLowResolution()
{
 CalculateMandelbrot(16);
 DrawMandelbrot();
}

function Tick()
{
 if (gDirty)
 {
  CalculateMandelbrot(16, 0);
  gProgressiveLevel = 8;
  gProgressiveIndex = 0;
  gDirty=false;
  gComplete=false;
 }
 else
 {
  CalculateMandelbrot(gProgressiveLevel, gProgressiveIndex);
  switch(gProgressiveLevel)
  {
   case 8:
    gProgressiveIndex++;
	if (gProgressiveIndex>=1) {gProgressiveLevel=4;gProgressiveIndex=0;}
    break;
   case 4:
    gProgressiveIndex++;
	if (gProgressiveIndex>=4) {gProgressiveLevel=2;gProgressiveIndex=0;}
    break;
   case 2:
    gProgressiveIndex++;
	if (gProgressiveIndex>=16) {gProgressiveLevel=1;gProgressiveIndex=0;}
    break;
   case 1:
    gProgressiveIndex++;
	if (gProgressiveIndex>=64) {gProgressiveLevel=0.5;gProgressiveIndex=0;}
    break;
   case 0.5:
    gProgressiveIndex++;
	if (gProgressiveIndex>=64) {gProgressiveLevel=0.25;gProgressiveIndex=0;}
    break;
   case 0.25:
    gProgressiveIndex++;
	if (gProgressiveIndex>=64) {gComplete=true;}
    break;
  }
 }
 
// if (!gComplete)
  DrawMandelbrot();

 // next tick
 if (!stop)
  setTimeout(Tick, 17);
}

</SCRIPT>

</HEAD>
<BODY id="body">

<DIV style="float: left;">
<CANVAS id="canvas1" width="1280" height="700" style="border:1px solid #000000;"></canvas>
</DIV>
<DIV style="float: left;">
<DIV style="border:1px;width:200px;float: left;" ><B>Simulation Controls</B></DIV>
<BR>
<BUTTON id="reset" onclick="guiDraw()" style="width:200px">Draw</button>
<BR>
<BUTTON id="reset" onclick="guiZoomIn()" style="width:200px">Zoom in</button>
<BR>
<BUTTON id="reset" onclick="guiZoomOut()" style="width:200px">Zoom out</button>
<BR>
<BUTTON id="reset" onclick="guiMoveUp()" style="width:200px">Move Up</button>
<BR>
<BUTTON id="reset" onclick="guiMoveDown()" style="width:200px">Move Down</button>
<BR>
<BUTTON id="reset" onclick="guiMoveLeft()" style="width:200px">Move Left</button>
<BR>
<BUTTON id="reset" onclick="guiMoveRight()" style="width:200px">Move Right</button>
<BR>
<DIV style="border:1px;width:140px;float: left;" ><INPUT id="smoothShading" type="checkbox" onchange="guiReadParameters()">Smooth Shading</INPUT></DIV>
<BR>
<BR>

<DIV style="border:1px;width:200px;float: left;" ><B>Parameters</B></DIV>
<BR>
<DIV style="border:1px;width:140px;float: left;" >Initial Animals</DIV><INPUT id="initialAnimals" style="width:60px" style="text-align:right;" onchange="guiReadParameters()"/></input>
<BR>
<DIV style="border:1px;width:140px;float: left;" >Zoom</DIV><INPUT id="zoom" style="width:60px" style="text-align:right;" onchange="guiReadParameters()"/></input>
<BR>
<BR>

</DIV>

<script>
Initialise();
</script>
</BODY>
</HTML>